name: Test Nix S3 Cache Action

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  R2_BUCKET: nix-cache-test

jobs:
  test-error-no-nix:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Try to setup cache without Nix
      id: setup
      uses: ./.github/actions/setup-nix-s3-cache
      continue-on-error: true
      with:
        s3-endpoint: https://example.com
        bucket: dummy-bucket
        public-key: dummy:key
        aws-access-key-id: dummy-key
        aws-secret-access-key: dummy-secret

    - name: Check that action failed
      run: |
        if [ "${{ steps.setup.outcome }}" == "failure" ]; then
          echo "✅ Action correctly failed without Nix installed"
        else
          echo "❌ Action should have failed when Nix is not installed"
          exit 1
        fi

  test-cache:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Determinate Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Setup Nix S3 Cache
      uses: ./.github/actions/setup-nix-s3-cache
      with:
        s3-endpoint: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
        bucket: ${{ env.R2_BUCKET }}
        public-key: ${{ secrets.NIX_CACHE_PUBLIC_KEY }}
        private-key: ${{ secrets.NIX_CACHE_PRIVATE_KEY }}
        aws-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}

    - name: Build test package
      run: nix build nixpkgs#hello
      timeout-minutes: 10

    - name: Verify cache upload
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      run: |
        # Wait a moment for upload to complete
        sleep 5
        
        # List objects in the bucket to verify upload
        OBJECT_COUNT=$(aws s3 ls s3://${{ env.R2_BUCKET }}/ --endpoint-url https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com --recursive | wc -l)
        
        if [ "$OBJECT_COUNT" -gt 0 ]; then
          echo "✅ Cache upload successful: $OBJECT_COUNT objects found in bucket"
        else
          echo "❌ Cache upload failed: no objects found in bucket"
          exit 1
        fi