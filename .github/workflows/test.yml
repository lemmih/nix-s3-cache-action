name: Test Nix S3 Cache Action

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  R2_BUCKET: nix-cache-test
  AWS_BUCKET: nix-cache-test-lemmih

jobs:
  test-error-no-nix:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Try to setup cache without Nix
      id: setup
      run: |
        export INPUT_S3_ENDPOINT="https://example.com"
        export INPUT_BUCKET="dummy-bucket"
        export INPUT_PUBLIC_KEY="dummy:key"
        export INPUT_AWS_ACCESS_KEY_ID="dummy-key"
        export INPUT_AWS_SECRET_ACCESS_KEY="dummy-secret"
        if output=$(bash .github/actions/setup-nix-s3-cache/setup.sh 2>&1); then
          echo "should_have_failed=true" >> "$GITHUB_OUTPUT"
          echo "output=$output" >> "$GITHUB_OUTPUT"
        else
          echo "should_have_failed=false" >> "$GITHUB_OUTPUT"
          echo "output=$output" >> "$GITHUB_OUTPUT"
        fi
      continue-on-error: true

    - name: Check that script failed with correct error message
      run: |
        if [ "${{ steps.setup.outputs.should_have_failed }}" == "false" ]; then
          if echo "${{ steps.setup.outputs.output }}" | grep -q "Nix is not installed"; then
            echo "✅ Script correctly failed with informative error message"
          else
            echo "❌ Script failed but with wrong error message: ${{ steps.setup.outputs.output }}"
            exit 1
          fi
        else
          echo "❌ Script should have failed when Nix is not installed"
          exit 1
        fi

  test-error-missing-bucket:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Determinate Nix
      uses: DeterminateSystems/nix-installer-action@e4fb5e65d88bc1ed7f248eda4e6645126ed90438 # main

    - name: Try to setup cache with non-existent bucket
      id: setup
      run: |
        export INPUT_S3_ENDPOINT="${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com"
        export INPUT_BUCKET="non-existent-bucket-12345"
        export INPUT_PUBLIC_KEY="dummy:key"
        export INPUT_AWS_ACCESS_KEY_ID="${{ secrets.R2_ACCESS_KEY_ID }}"
        export INPUT_AWS_SECRET_ACCESS_KEY="${{ secrets.R2_SECRET_ACCESS_KEY }}"
        if output=$(bash .github/actions/setup-nix-s3-cache/setup.sh 2>&1); then
          echo "should_have_failed=true" >> "$GITHUB_OUTPUT"
          echo "output=$output" >> "$GITHUB_OUTPUT"
        else
          echo "should_have_failed=false" >> "$GITHUB_OUTPUT"
          echo "output=$output" >> "$GITHUB_OUTPUT"
        fi
      continue-on-error: true

    - name: Check that script failed with bucket error
      run: |
        if [ "${{ steps.setup.outputs.should_have_failed }}" == "false" ]; then
          if echo "${{ steps.setup.outputs.output }}" | grep -q "bucket.*does not exist"; then
            echo "✅ Script correctly failed with bucket error message"
          else
            echo "❌ Script failed but with wrong error message: ${{ steps.setup.outputs.output }}"
            exit 1
          fi
        else
          echo "❌ Script should have failed with non-existent bucket"
          exit 1
        fi

  test-cache:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Determinate Nix
      uses: DeterminateSystems/nix-installer-action@e4fb5e65d88bc1ed7f248eda4e6645126ed90438 # main

    - name: Setup Nix S3 Cache
      uses: ./.github/actions/setup-nix-s3-cache
      with:
        s3-endpoint: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
        bucket: ${{ env.R2_BUCKET }}
        public-key: ${{ secrets.NIX_CACHE_PUBLIC_KEY }}
        private-key: ${{ secrets.NIX_CACHE_PRIVATE_KEY }}
        aws-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}

    - name: Build test package
      run: nix build nixpkgs#hello
      timeout-minutes: 10

    - name: Verify cache upload
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      run: |
        # Wait a moment for upload to complete
        sleep 5

        # List objects in the bucket to verify upload
        OBJECT_COUNT=$(aws s3 ls s3://${{ env.R2_BUCKET }}/ --endpoint-url https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com --recursive | wc -l)

        if [ "$OBJECT_COUNT" -gt 0 ]; then
          echo "✅ Cache upload successful: $OBJECT_COUNT objects found in bucket"
        else
          echo "❌ Cache upload failed: no objects found in bucket"
          exit 1
        fi

  test-create-bucket:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Determinate Nix
      uses: DeterminateSystems/nix-installer-action@e4fb5e65d88bc1ed7f248eda4e6645126ed90438 # main

    - name: Generate unique bucket name
      id: bucket
      run: echo "name=nix-cache-test-${{ github.run_id }}" >> "$GITHUB_OUTPUT"

    - name: Setup Nix S3 Cache with create-bucket
      uses: ./.github/actions/setup-nix-s3-cache
      with:
        s3-endpoint: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
        bucket: ${{ steps.bucket.outputs.name }}
        public-key: ${{ secrets.NIX_CACHE_PUBLIC_KEY }}
        private-key: ${{ secrets.NIX_CACHE_PRIVATE_KEY }}
        aws-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        create-bucket: true

    - name: Build test package
      run: nix build nixpkgs#hello
      timeout-minutes: 10

    - name: Verify cache upload
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      run: |
        # Wait a moment for upload to complete
        sleep 5

        # List objects in the bucket to verify upload
        OBJECT_COUNT=$(aws s3 ls s3://${{ steps.bucket.outputs.name }}/ --endpoint-url https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com --recursive | wc -l)

        if [ "$OBJECT_COUNT" -gt 0 ]; then
          echo "✅ Cache upload successful: $OBJECT_COUNT objects found in bucket"
        else
          echo "❌ Cache upload failed: no objects found in bucket"
          exit 1
        fi

    - name: Cleanup test bucket
      if: always()
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      run: |
        # Delete all objects in the bucket
        aws s3 rm s3://${{ steps.bucket.outputs.name }}/ --endpoint-url https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com --recursive || true
        # Delete the bucket
        aws s3 rb s3://${{ steps.bucket.outputs.name }} --endpoint-url https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com || true

  test-cache-aws:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::893216290718:role/github-s3
        aws-region: us-east-2

    - name: Install Determinate Nix
      uses: DeterminateSystems/nix-installer-action@e4fb5e65d88bc1ed7f248eda4e6645126ed90438 # main

    - name: Setup Nix S3 Cache with AWS
      uses: ./.github/actions/setup-nix-s3-cache
      with:
        s3-endpoint: s3.amazonaws.com
        bucket: ${{ env.AWS_BUCKET }}
        public-key: ${{ secrets.NIX_CACHE_PUBLIC_KEY }}
        private-key: ${{ secrets.NIX_CACHE_PRIVATE_KEY }}

    - name: Build unique test derivation
      run: |
        # Build a unique derivation that won't be in any cache
        # This ensures the post-build hook is triggered
        nix build --impure --expr "
          derivation {
            name = \"nix-s3-cache-test-${{ github.run_id }}\";
            system = builtins.currentSystem;
            builder = \"/bin/sh\";
            args = [ \"-c\" \"echo 'Test derivation for run ${{ github.run_id }}' > \$out\" ];
          }
        "
      timeout-minutes: 10

    - name: Verify cache upload
      run: |
        # Wait a moment for upload to complete
        sleep 5

        # List objects in the bucket to verify upload
        OBJECT_COUNT=$(aws s3 ls s3://${{ env.AWS_BUCKET }}/ --recursive | wc -l)

        if [ "$OBJECT_COUNT" -gt 0 ]; then
          echo "✅ Cache upload successful: $OBJECT_COUNT objects found in bucket"
        else
          echo "❌ Cache upload failed: no objects found in bucket"
          exit 1
        fi

    - name: Cleanup test objects
      if: always()
      run: |
        # Delete test objects from bucket to keep it clean
        aws s3 rm s3://${{ env.AWS_BUCKET }}/ --recursive || true

  test-cache-tebi:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Determinate Nix
      uses: DeterminateSystems/nix-installer-action@e4fb5e65d88bc1ed7f248eda4e6645126ed90438 # main

    - name: Setup Nix S3 Cache with Tebi
      uses: ./.github/actions/setup-nix-s3-cache
      with:
        s3-endpoint: s3.tebi.io
        bucket: nix-cache-test
        public-key: ${{ secrets.NIX_CACHE_PUBLIC_KEY }}
        private-key: ${{ secrets.NIX_CACHE_PRIVATE_KEY }}
        aws-access-key-id: ${{ secrets.TEBI_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.TEBI_SECRET_ACCESS_KEY }}

    - name: Build test package
      run: nix build nixpkgs#hello
      timeout-minutes: 10

    - name: Verify cache upload
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.TEBI_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.TEBI_SECRET_ACCESS_KEY }}
      run: |
        # Wait a moment for upload to complete
        sleep 5

        # List objects in the bucket to verify upload
        OBJECT_COUNT=$(aws s3 ls s3://nix-cache-test/ --endpoint-url https://s3.tebi.io --recursive | wc -l)

        if [ "$OBJECT_COUNT" -gt 0 ]; then
          echo "✅ Cache upload successful: $OBJECT_COUNT objects found in bucket"
        else
          echo "❌ Cache upload failed: no objects found in bucket"
          exit 1
        fi
